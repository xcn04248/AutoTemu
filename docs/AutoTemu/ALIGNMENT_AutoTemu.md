# ALIGNMENT - AutoTemu 货品发布API更新对齐文档

## 项目上下文分析

### 现有项目架构
AutoTemu是一个完整的自动化商品爬取和上架系统，采用模块化设计：

**核心模块结构：**
- `src/scraper/` - 商品信息爬取模块（基于Firecrawl）
- `src/image/` - 图片处理模块（OCR识别、中文过滤）
- `src/transform/` - 数据转换模块（爬取数据→Temu格式）
- `src/core/` - 核心业务逻辑（ProductManager）
- `src/models/` - 数据模型定义
- `src/utils/` - 工具模块（配置、日志、异常处理）

**技术栈：**
- Python 3.8+
- `temu_api` 官方库
- Firecrawl网页爬取
- 百度OCR API
- PIL图像处理

### 现有API集成方式
当前使用 `temu_api` 官方库的 `TemuClient` 类：
```python
self.temu_client = TemuClient(
    app_key=os.getenv("TEMU_APP_KEY"),
    app_secret=os.getenv("TEMU_APP_SECRET"),
    access_token=os.getenv("TEMU_ACCESS_TOKEN"),
    base_url=os.getenv("TEMU_BASE_URL", "https://openapi-b-global.temu.com")
)
```

**现有商品创建流程：**
1. 使用 `temu_client.product.goods_add()` 方法
2. 参数结构：`goods_basic`, `goods_service_promise`, `goods_property`, `sku_list`
3. 图片上传：`temu_client.product.image_upload()`
4. 尺码表：`goodsSizeChartList` 参数

## 需求理解确认

### 原始需求
根据最新货品发布文档 `docs/货品发布.md`，需要对现有代码进行重要且大型的更新，以适配新的API规范。

### 边界确认（明确任务范围）

**包含范围：**
1. **API接口更新** - 从 `temu_api` 库迁移到新的 `bg.goods.add` 接口
2. **参数结构重构** - 完全重写商品创建参数结构
3. **签名算法实现** - 实现新的签名验证机制
4. **图片处理流程** - 适配新的图片上传和引用方式
5. **尺码表处理** - 使用新的尺码表接口族
6. **数据模型更新** - 更新数据模型以匹配新API格式
7. **错误处理优化** - 适配新的错误码和响应格式

**不包含范围：**
1. 爬虫逻辑修改（保持现有Firecrawl实现）
2. OCR功能修改（保持现有百度OCR实现）
3. 基础工具模块修改（配置、日志、异常处理）
4. 用户界面修改（命令行接口保持不变）

### 需求理解（对现有项目的理解）

**现有项目优势：**
- 完整的模块化架构，便于局部更新
- 完善的错误处理和重试机制
- 详细的日志记录系统
- 灵活的数据转换管道

**现有项目约束：**
- 依赖 `temu_api` 官方库的API格式
- 数据模型与旧API紧密耦合
- 图片处理流程与旧API绑定
- 签名机制由库内部处理

**业务域理解：**
- 主要面向日本站商品上架
- 支持服装类商品（需要尺码表）
- 需要处理中文图片过滤
- 价格需要加价处理（默认30%）

### 疑问澄清（存在歧义的地方）

**关键决策点1：API迁移策略**
- 是否完全废弃 `temu_api` 库？
- 是否需要保持向后兼容性？
- 如何处理其他API（如分类查询、图片上传）？

**关键决策点2：数据模型更新范围**
- 是否需要保持现有 `ProductData` 和 `TemuProduct` 模型？
- 是否需要创建新的API格式数据模型？
- 如何处理数据转换的兼容性？

**关键决策点3：错误处理策略**
- 如何处理新API的错误码？
- 是否需要更新重试机制？
- 如何保持现有的错误处理一致性？

**关键决策点4：测试策略**
- 是否需要更新现有测试用例？
- 如何确保更新后的功能正确性？
- 是否需要创建新的测试数据？

## 智能决策策略

### 基于现有项目内容的决策

**决策1：渐进式API迁移**
- 保持现有模块结构，仅更新API调用层
- 创建新的API客户端类，与现有 `TemuClient` 并行
- 逐步迁移各个功能模块

**决策2：数据模型扩展**
- 保持现有 `ProductData` 模型不变
- 创建新的 `BgGoodsAddData` 模型用于新API
- 在数据转换层处理格式差异

**决策3：错误处理统一**
- 保持现有异常处理体系
- 创建新的错误码映射
- 统一错误响应格式

**决策4：测试策略**
- 保持现有测试框架
- 创建新的API测试用例
- 使用金测试验证功能正确性

### 基于行业知识的决策

**API设计最佳实践：**
- 使用适配器模式处理API差异
- 保持业务逻辑与API实现分离
- 实现配置化的API端点切换

**错误处理最佳实践：**
- 实现统一的错误码映射
- 提供详细的错误信息
- 支持错误重试和降级

**测试最佳实践：**
- 使用Mock对象隔离外部依赖
- 实现集成测试验证端到端流程
- 保持测试数据的真实性

## 项目特性规范已对齐

### 技术约束
- 保持Python 3.8+兼容性
- 保持现有依赖库的使用
- 保持模块化架构设计
- 保持现有配置管理方式

### 集成方案
- 新API客户端与现有系统集成
- 数据模型向后兼容
- 错误处理统一化
- 日志记录一致性

### 质量要求
- 保持现有测试覆盖率
- 保持代码质量标准
- 保持文档完整性
- 保持性能要求

## 最终共识

基于以上分析，本次更新将采用**渐进式迁移策略**，在保持现有架构和功能的基础上，逐步适配新的API规范。更新将重点关注API调用层的重构，同时保持业务逻辑和数据模型的稳定性。

**核心原则：**
1. 最小化破坏性变更
2. 保持向后兼容性
3. 确保功能完整性
4. 维护代码质量

**验收标准：**
1. 所有现有功能正常工作
2. 新API调用成功
3. 商品上架流程完整
4. 错误处理正确
5. 测试用例通过